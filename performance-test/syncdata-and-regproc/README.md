# Contains
* This directory contains performance Test script of below API endpoint categories.
	01. A00 Auth Token Generation (Preparation)
	02. A01 Create Users and Centers for Zones (Setup)
	03. A02 Create Machines (Setup)
	04. P01 Create and Sync New Registration Packet (Preparation)
	05. P03 Generate RID (Preparation)
	06. S01 Sync And Upload New Registration Packet (Execution)
	07. S02 Sync Data From The Server (Execution)
	08. S03 Get Transaction Details From Reg Id (Execution)

* Open source tools used,
	01. [Java 21](https://www.oracle.com/java/technologies/downloads/#java21)
	02. [Apache JMeter 5.6.3](https://jmeter.apache.org/download_jmeter.cgi) 
	03. [mosip-packet-creator](https://github.com/mosip/mosip-automation-tests/tree/master/mosip-packet-creator)


# How to run performance scripts using Apache JMeter tool
* Download Apache JMeter from https://jmeter.apache.org/download_jmeter.cgi
* Download JMeter Plugin Manager jar file from https://jmeter-plugins.org/get/ , and install by placing the it in "Jmeter/apache-jmeter-X.X.X/lib/ext"
* Download scripts for the required module from the respective module repo's.
* Start JMeter by running the jmeter.bat file for Windows or jmeter file for Unix. 
* Load downloaded *.jmx script onto Jmeter. If prompted, install the required plugins.
* Update "User Defined Variables" within the Jmeter scripts. This list holds environement endpoint URL, protocols, users, secret keys, passwords, runtime file path, support file path etc.
* Validate the scripts for one user.
* Take average scenario response time obtained from above test and update "Scenario Response time" column in [MOSIP_TPS_Thread_setting_calculator](MOSIP_TPS_Thread_setting_calculator-RegProc_SyncData.xlsx)
* Execute a dry run for 10 min. The execution duration is controlled by "testDuration" variable.
* Use [MOSIP_TPS_Thread_setting_calculator](MOSIP_TPS_Thread_setting_calculator-RegProc_SyncData.xlsx) to calculate the thread settings required for your target load.
* Execute performance run with various loads in order to achieve targeted NFR's.


# Setup points before execution
* This script uses `mosip-packet-creator` tool as a background service to generate new packets. Follow the steps in [PacketCreatorToolSetup](PacketCreatorToolSetup.md) first to start the service. The tool should be running in background while the jmeter script is running. 
* `A02 Create Machines` creates a large number of Machines based on requirements within the Master Database that contains unique keys. 5000 pregenerated keys are available in [generated_keys](KeyGenMadeEasy/generated_keys.7z). More keys can be generated by running [KeyGenMadeEasy](KeyGenMadeEasy/README.md) script. 
* `S03 Get Transaction details from RID` requires a existing list of RIDs in the database. If RIDs do not already exist, new RIDs can be created using [PacketCreator_and_Upload_Test_Script](../packet-credential-processing/README.md) as well. 
* The "registration-processor-common-camel-bridge" pod should be stopped until all preparation (P01-P03) is completed. (i.e. Number of pods = 0).
* Delete runtime files created during previous execution from {runTimeFilePath} folder.



# Script execution steps:

	* A00 Auth Token Generation (Preparation) - In this thread group we are creating the authorization token values of  Regpoc and  Resident - Using User Id which will be saved to a file in the Run Time Files in bin folder of JMeter. The authorization token have expiration time which is controlled by MOSIP settings. Ensure the tokens remain valid throughout the duration of the test execution.

	* A01 Create Users and Centers for Zones (Setup) - This thread group will create a list of users and centers within the master DB and activate them. The centers will be based on the list of zones and location provided in "D01_A01_zones.csv". This step only needs to be executed once per environment.
	
	* A02 Create Machines (Setup) - This thread group will create a list of Machines within the master DB and activate them. The list will be based on the list of Centers created under step A01. The machines will also use the keys provided in the folderpath "{keyPath}/reg_######". These keys can be generated using `KeyGenMadeEasy` script. This step only needs to be executed once per environment.

	* P01 Sync And Upload New Registration Packet(Preparation) - This thread group generates unique identity packets, saves them as zipped files to 'mounthpath' and syns them to PacketCreator tool. As a prerequisite, PacketCreator tool is required to run as background service. (Check PacketCreatorToolSetup.md to run this tool). The execution of this step is identical to `./PacketCreator/PacketCreator_and_Upload_Test_Script.jmx`. The list of packets is stored in P01_request_body_sync_packet.txt

	* P03 Generate RID (Preparation) - If database has valid RIDs, this step is not required. Populate support-files/reg_id.txt with the list of RIDs as shown in sample. If the database does not already consists of valid RIDs, this thread group can be used to create them. It will consume the data created by "P01 Sync And Upload New Registration Packet" and generate a list that can be used by "S03 Get Transaction Details From Reg Id". If this thread is executed. "P01 Sync And Upload New Registration Packet" should be re-executed to generate new data for "S01 Sync And Upload New Registration Packet".

	* Additional preparation step - Make sure the "registration-processor-common-camel-bridge" pod is stopped before executing below test (Execution thread groups). (i.e. Number of pods = 0).
	
	* S01 Sync And Upload New Registration Packet(Execution) : 
		* S01 T01 Sync Registration Packet : This API endpoint will sync the packets in registration processor.
		* S01 T02 Upload Registration Packet : This API endpoint will upload the packets to registration processor.

	* S02 Sync Data From The Server (Execution) :
		* S02 T01 Auth Token Details Encrypted Based On Machine Key : This API endpoint sync the auth token details based on machine key.
		* S02 T02 Public Key Verify : This API endpoint verifies the public key generated.
		* S02 T03 Get Certificate : This API endpoint gets the certificates.
		* S02 T04 Get User Details : This API endpoint gets the user details.
		* S02 T05 Get Client Settings : This API endpoint gets the client settings.
		* S02 T06 Get Configs : This API endpoint gets the config settings.
		* S02 T07 Get LatestId Schema : This API endpoint gets the latest schema ID.
		* S02 T08 Get CaCertificates : This API endpoint gets CA certificates.

	* S03 Get Transaction Details From Reg Id (Execution) :
		* S03 T01 Get Transaction Details From Reg Id : This API endpoint will fetch the transaction details using reg id.


## Designing the workload model for performance test execution

* The script is preconfigured for 100 tps within our test environement. Performance may vary based on hardware and infreastructure settings.

* If you are testing for different tps or with different hardware settings, adjustment needs to made to thread group settings within the script.

* [MOSIP_TPS_Thread_setting_calculator-packet_credential_processing.xlsx](MOSIP_TPS_Thread_setting_calculator-RegProc_SyncData.xlsx) applies Little's law to recommend required thread settings inputs.			
					
## Support files required for this test execution:

1. [contextDetails.csv](support-files/context_details.csv) - This support file contains userId, password, center and machine details.
2. [D01_A01_zones.csv](support-files/D01_A01_zones.csv) - This support file should contain list of valid zones in master database where a center can be created. The file should be manually created.
3. [A01_A02_center_id.csv](support-files/A01_A02_center_id.csv) - This support file contains list of centers needed to create new machine. It can be created from step A01.
4. [A02_S02_machine_id.csv](support-files/A02_S02_machine_id.csv) - This support file contains list of machines in the master db. It can be created from step A02.
5. [D02_S02T03_KeyAlias.csv](support-files/D02_S02T03_KeyAlias.csv) - This support file contains list of Certificate details from database. The file should be manually created.
6. [reg_id](support-files/reg_id.txt) - This support file contains list of registration ids in the database. It can be created from step P03. 

